const fs = require('fs');
const path = require('path');
const Mocha = require('mocha');

function getTestSuites(rootPath) {
    const suite = new Mocha.Suite(path.basename(rootPath));
    const items = fs.readdirSync(rootPath).map(f => path.join(rootPath, f));
    items.forEach((f) => {
        if (f.endsWith('index.js')) return;

        const stat = fs.statSync(f);

        if (stat.isDirectory()) {
            suite.addSuite(getTestSuites(f));
            return;
        }

        const m = new Mocha();
        m.addFile(f);
        m.loadFiles();
        m.suite.title = path.basename(f, '.js');
        suite.addSuite(m.suite);
    });

    return suite;
}

function run() {
    const suite = getTestSuites('test');

    let opts = {};

    if (process.env.TEST_RESULTS) {
        opts = Object.assign(opts, {
            reporter: 'mocha-junit-reporter',
            reporterOptions: {
                mochaFile: path.join(process.env.TEST_RESULTS, 'test-results.xml'),
            },
        });
    }

    const mocha = new Mocha(opts);
    suite.suites.map(s => mocha.suite.addSuite(s));
    mocha.run();
}

module.exports = {
    run,
};
